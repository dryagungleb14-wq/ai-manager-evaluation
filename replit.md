# AI-сервис оценки работы менеджеров

## Описание проекта
Пилотный веб-сервис для автоматической оценки качества работы менеджеров через анализ звонков и переписок с клиентами. Система использует AI для проверки диалогов по настраиваемым чек-листам, выявления возражений и формирования детальных отчётов.

## Технологический стек

### Frontend
- **React** с TypeScript
- **Vite** для сборки
- **Tailwind CSS** + **Shadcn UI** для стилизации
- **Wouter** для роутинга
- **React Query** для управления состоянием
- **React Dropzone** для загрузки файлов

### Backend
- **Node.js** + **Express**
- **Google Gemini 2.5 Flash API** для распознавания речи (ASR) и анализа диалогов (LLM)
- **Multer** для обработки файлов
- **Zod** для валидации данных
- **PDFKit** для генерации PDF отчётов

### Хранение данных
- **PostgreSQL** для чек-листов и истории анализов
- **Drizzle ORM** для type-safe работы с БД
- **Последние 10 анализов** хранятся с полными отчётами
- **Аудиофайлы не сохраняются** - удаляются после транскрипции

## Основные возможности

### 1. Анализ звонков
- Загрузка аудиофайлов (MP3, WAV, M4A, OGG, FLAC, WEBM, OPUS)
- Автоматическая транскрипция через **Gemini 2.5 Flash** (бесплатно!)
- До 8.4 часов аудио
- Редактирование расшифровки перед анализом
- Многоязычная поддержка (авто-определение языка)

### 2. Анализ переписок
- Ввод текста вручную или загрузка .txt файлов
- Поддержка drag-and-drop интерфейса
- Валидация и предобработка текста

### 3. Управление чек-листами
- Создание и редактирование чек-листов
- Три типа пунктов: обязательный, рекомендуемый, запрещённый
- **Умная загрузка из файлов** (NEW!)
  - TXT/MD: AI автоматически понимает структуру через Gemini
  - CSV: Колонки "Пункт", "Тип", "Описание" (гибкие названия)
  - Excel (XLSX/XLS): Та же структура что и CSV
  - Drag-and-drop интерфейс
- Импорт/экспорт в JSON формате
- Дублирование чек-листов
- Предзагруженные примеры для B2B продаж и поддержки

### 4. AI-анализ
- Проверка диалога по всем пунктам чек-листа
- Оценка выполнения с уверенностью (0-1)
- Извлечение цитат с таймкодами
- Автоматическое выявление возражений клиента
- Категоризация возражений
- Оценка качества обработки возражений
- Формирование сути разговора (1-3 предложения)
- Фиксация итога и следующих шагов

### 5. Отчёты
- **Отчёт по чек-листу**: статусы, оценки, цитаты, общая сводка
- **Отчёт по возражениям**: категории, обработка, рекомендации
- Визуальное отображение с прогресс-барами и иконками
- Адаптивный дизайн для всех устройств

## Структура проекта

```
├── client/                    # Frontend приложение
│   ├── src/
│   │   ├── components/       # React компоненты
│   │   │   ├── ui/          # Shadcn UI компоненты
│   │   │   ├── audio-upload.tsx
│   │   │   ├── text-input.tsx
│   │   │   ├── transcript-editor.tsx
│   │   │   ├── checklist-selector.tsx
│   │   │   ├── checklist-editor.tsx
│   │   │   ├── analysis-results.tsx
│   │   │   └── theme-toggle.tsx
│   │   ├── lib/             # Утилиты
│   │   │   ├── theme-provider.tsx
│   │   │   ├── default-checklists.ts
│   │   │   └── checklist-storage.ts
│   │   ├── pages/           # Страницы
│   │   │   ├── home.tsx
│   │   │   ├── history.tsx
│   │   │   ├── analysis-detail.tsx
│   │   │   └── not-found.tsx
│   │   └── App.tsx
│   └── index.html
├── server/                   # Backend сервер
│   ├── routes.ts            # API endpoints
│   ├── storage.ts           # Интерфейс хранилища
│   ├── services/            # Бизнес-логика
│   │   ├── whisper.ts      # OpenAI Whisper интеграция
│   │   └── gemini.ts       # Gemini AI интеграция
│   └── index.ts
├── shared/                   # Общий код
│   └── schema.ts            # Типы и схемы Zod
└── design_guidelines.md     # Дизайн-система проекта
```

## API Endpoints

### POST /api/transcribe
Транскрибация аудио в текст
- **Input**: multipart/form-data с аудиофайлом
- **Output**: { transcript, language }

### POST /api/analyze
Анализ диалога по чек-листу
- **Input**: { transcript, checklist, language?, source }
- **Output**: { checklistReport, objectionsReport, id }

### GET /api/analyses
Получить список последних 10 анализов (новые первые)
- **Лимит**: 10 записей
- **Сортировка**: DESC по дате анализа
- **Output**: Array<{ id, source, language, transcript, analyzedAt, checklistReport, objectionsReport }>

### GET /api/analyses/:id
Получить конкретный анализ по ID
- **Output**: AnalysisReport с полными данными

### GET /api/analyses/:id/markdown
Скачать отчёт в Markdown формате
- **Output**: Файл .md с форматированным отчётом

### GET /api/analyses/:id/pdf
Скачать отчёт в PDF формате
- **Output**: Файл .pdf с профессиональным форматированием

### POST /api/checklists/upload
Загрузить и распарсить чек-лист из файла
- **Input**: multipart/form-data с файлом (.txt, .md, .csv, .xlsx, .xls)
- **Output**: Созданный Checklist объект
- **Форматы**:
  - TXT/MD: AI парсинг через Gemini (требуется GEMINI_API_KEY)
  - CSV/Excel: Автоматический парсинг колонок "Пункт", "Тип", "Описание"

## Переменные окружения

```
GEMINI_API_KEY=...     # Ключ для Google Gemini API (транскрипция + анализ)
DATABASE_URL=...       # PostgreSQL (автоматически в Replit)
SESSION_SECRET=...     # Секрет для сессий (автоматически)
```

## Запуск проекта

### Локально
```bash
npm install
npm run dev
```

### На Replit
Проект автоматически запускается через команду `npm run dev`, которая:
1. Запускает Vite dev server на порту 5000 (frontend)
2. Запускает Express server (backend с API)

## Особенности реализации

### Дизайн-система
- **Темная тема** по умолчанию с поддержкой светлой
- **Цветовая палитра**: Professional B2B стиль
- **Типографика**: Inter для UI, JetBrains Mono для кода
- **Компоненты**: Полностью на Shadcn UI
- **Иконки**: Lucide React

### Обработка ошибок
- Graceful error handling с информативными сообщениями
- Toast-уведомления для пользователя
- Возможность повтора запроса при ошибке
- Валидация данных на клиенте и сервере

### AI Промпты
- Структурированные промпты для Gemini
- JSON Schema validation для ответов
- Поддержка русского языка
- Обработка edge cases (нет возражений, неполные данные)

## Реализованные возможности (✅ Completed)

1. **✅ PostgreSQL База данных**: Полная миграция с in-memory на PostgreSQL
   - Drizzle ORM для управления схемой
   - Таблицы: checklists, analyses, managers
   - DatabaseStorage с поддержкой всех CRUD операций
   - Автоматическая инициализация с дефолтными чек-листами и менеджерами

2. **✅ История анализов**: Сохранение и просмотр последних 10 анализов
   - Страница /history с последними 10 анализами (сортировка: новые первые)
   - Детальный просмотр каждого анализа на /history/:id
   - Навигация: Главная ↔ История ↔ Детальный просмотр
   - API endpoints: GET /api/analyses (лимит 10, DESC), GET /api/analyses/:id
   - Оптимизированная БД-запрос с `orderBy(desc())` и `limit(10)`
   - Правильная сериализация дат (ISO string)
   - React Query для оптимистичных обновлений
   - **Аудиофайлы не хранятся** - только отчёты и транскрипты

3. **✅ Экспорт в Markdown**: Скачивание отчётов в Markdown формате
   - Сервис server/services/markdown-generator.ts
   - Форматирование с таблицами, заголовками, цитатами
   - Endpoint: GET /api/analyses/:id/markdown
   - Кнопка скачивания в интерфейсе результатов

4. **✅ Экспорт в PDF**: Скачивание отчётов в PDF формате
   - PDFKit для генерации PDF (serverless-friendly)
   - Сервис server/services/pdf-generator.ts
   - Профессиональное форматирование с заголовками, таблицами
   - Endpoint: GET /api/analyses/:id/pdf
   - Кнопка скачивания в интерфейсе результатов
   - E2E тестирование подтвердило работоспособность

5. **✅ Атрибуция менеджеров (Manager Attribution MVP - Phase 1/4)**:
   - Таблица managers: id, name, phone, email, teamLead, department, timestamps
   - Связь analyses.managerId → managers.id (nullable FK)
   - API endpoints: GET/POST/PUT/DELETE /api/managers
   - Seed данные: 8 тестовых менеджеров (3 отдела: Продажи B2B, Продажи B2C, Поддержка)
   - Frontend ManagerSelector: выбор менеджера перед анализом
   - Страница /managers: CRUD управление менеджерами (таблица + форма)
   - Навигация: кнопка "Менеджеры" в header главной страницы
   - POST /api/analyze расширен для принятия managerId
   
   **Следующие фазы (Phase 2-4)**:
   - Phase 2: Telphin API интеграция (автоматическая атрибуция по номеру телефона)
   - Phase 3: Slack отчеты тимлидам
   - Phase 4: Аналитика по менеджерам и командам

## Следующие этапы (Post-MVP)

1. **Мультиязычность**: Поддержка английского языка
2. **Аналитика**: Статистика по менеджерам и периодам
3. **Vercel deployment**: Оптимизация для serverless
4. **Офлайн режим**: Локальные ASR/LLM модели

## Технические решения

### Почему Gemini для транскрипции И анализа?
- **Бесплатный tier** с щедрыми лимитами
- **Одно API** для всего (транскрипция + анализ)
- Отличная поддержка русского языка
- Structured output с JSON Schema
- До 8.4 часов аудио (против 25MB у OpenAI)
- Нет необходимости в OpenAI API ключе

### Почему PostgreSQL?
- Полное сохранение истории анализов
- Надёжное хранение чек-листов
- Автоматические бэкапы в Replit
- Drizzle ORM для type-safety
- Легко масштабируется

### Почему PDFKit вместо Puppeteer?
- Serverless-friendly (~5MB vs ~65MB)
- Не требует Chrome binaries
- Быстрая генерация PDF
- Подходит для Vercel deployment
